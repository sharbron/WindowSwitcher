name: Diagnostic

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  diagnose:
    name: Diagnose Build Issues
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Environment Info
        run: |
          echo "=== System Info ==="
          sw_vers
          echo ""
          echo "=== Xcode Info ==="
          xcodebuild -version
          xcrun --show-sdk-path
          echo ""
          echo "=== Swift Info ==="
          swift --version
          echo ""
          echo "=== Available Xcodes ==="
          ls /Applications/ | grep Xcode || echo "No Xcode applications found"

      - name: Check Project Structure
        run: |
          echo "=== Project Files ==="
          ls -la
          echo ""
          echo "=== Package.swift ==="
          cat Package.swift
          echo ""
          echo "=== Source Files ==="
          find Sources -name "*.swift" | head -20
          echo ""
          echo "=== Test Files ==="
          find Tests -name "*.swift" | head -20

      - name: Try Build (Debug)
        continue-on-error: true
        run: |
          echo "=== Building Debug ==="
          swift build -c debug -v 2>&1 | tee build-debug.log

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: diagnostic-logs
          path: |
            build-debug.log
          retention-days: 7

      - name: Try SwiftLint
        continue-on-error: true
        run: |
          echo "=== Installing SwiftLint ==="
          brew install swiftlint
          echo ""
          echo "=== Running SwiftLint ==="
          swiftlint --version
          swiftlint 2>&1 | tee swiftlint.log || true

      - name: Try Tests
        continue-on-error: true
        run: |
          echo "=== Running Tests ==="
          swift test -v 2>&1 | tee test.log || true

      - name: Summary
        if: always()
        run: |
          echo "## Diagnostic Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the uploaded artifacts for detailed logs." >> $GITHUB_STEP_SUMMARY
